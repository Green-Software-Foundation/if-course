# SCI Walkthrough - Methodology & Implementation - Operational Carbon

Let's revisit our dependency tree to see what we did and what's remaining.

‚òëÔ∏è sci
- ‚òëÔ∏è operational-carbon
  - ‚úÖ operational-energy
    - ‚úÖ cpu-energy
      - üçÅ cpu-utilization(80)
      - üçÅ cloud-vendor(Microsoft Azure)
      - üçÅ cloud-instance-type(Standard_A2m_v2)
    - ‚úÖ memory-energy
      - üçÅ memory-utilization(8)
  - ‚òëÔ∏è carbon-intensity
    - üçÅ cloud-region(westeurope)
- ‚òëÔ∏è embodied-carbon
    - üçÅ cloud-vendor(Microsoft Azure)
    - üçÅ cloud-instance-type(Standard_A2m_v2)
- ‚òëÔ∏è functional-unit
  - üçÅ site-visits(550)

In this module we are going to work through the methodology for the operational carbon impact which depends on the carbon intensity impact.

## `carbon-intensity`

### Methodology

As discussed previously there are several good sources to obtain real-time and granular carbon intensity information, including WattTime, Electricity Maps, UK Grid. We do strongly recommend exploring and using those services since granular carbon intensity data is going to give you the most useful information regarding where to invest efforts in reduction.

For the training course and for other perhaps aggregate reporting purposes we have the RTC project from the GSF which has disclosed official coefficients from the major cloud providers which we can use in a pipeline.

The advantage of the RTC data set is that it already has data keyed by cloud provider and cloud region so you can query it directly using your `cloud-provider` and `cloud-region` observations, however the data is a yearly average so won't surface useful opportunities for carbon aware computing.

### Implementation

We'll use the `CSVLookup` plugin (introduced in the previous module) to query the RTC dataset. CSVLookup works by matching values from your observations against columns in a CSV file and returning values from other columns as new observations.

The RTC dataset is keyed by `cloud-provider` and `cloud-region`, which we already have in our defaults. We just need to configure a query that matches on both and returns the carbon intensity value.

There is one wrinkle: the column in the RTC CSV is called `grid-carbon-intensity-average-consumption-annual`, but we need it as `carbon-intensity` in our pipeline. Fortunately, CSVLookup supports a **tuple syntax** in the `output` config that lets you rename a column as it's output. Instead of just listing the column name, you provide a two-element array where the first element is the CSV column name and the second is the parameter name you want in your pipeline:

```yaml
carbon-intensity-from-region:
  method: CSVLookup                    # <1>
  path: builtin
  config:
    filepath: https://raw.githubusercontent.com/Green-Software-Foundation/real-time-cloud/refs/heads/main/Cloud_Region_Metadata.csv  # <2>
    query:                             # <3>
      cloud-provider: "cloud-provider"
      cloud-region: "cloud-region"
    output:                            # <4>
      - ['grid-carbon-intensity-average-consumption-annual', 'carbon-intensity']
```

- <1>: We use `CSVLookup` from the builtin standard library, the same plugin we used to look up CPU TDP in the previous module.
- <2>: The URL of the GSF's Real Time Cloud dataset, which contains carbon intensity data for major cloud providers and regions.
- <3>: The query matches on two columns ‚Äî `cloud-provider` and `cloud-region`. The values in quotes refer to observation parameters, so CSVLookup will look up the row where the CSV's `cloud-provider` column matches the value of `cloud-provider` in the current observation (e.g. "Microsoft Azure") and the `cloud-region` column matches our `cloud-region` value (e.g. "westeurope").
- <4>: The tuple syntax `['csv-column-name', 'output-parameter-name']` tells CSVLookup to read from the `grid-carbon-intensity-average-consumption-annual` column but output it as `carbon-intensity`. This avoids having to carry a long column name through the rest of the pipeline.

## `operational-carbon`

### Methodology

Now we have `carbon-intensity` and `operational-energy`, we simply need to multiply them together to create `operational-carbon`. 

### Implementation

We will use the Multiply plugin, and configure it to multiply `operational-energy` by `carbon-intensity` and output `operational-carbon` like so:

```yaml
calculate-operational-carbon:
  method: Multiply
  path: builtin
  config:
    input-parameters: 
      - operational-energy
      - carbon-intensity
    output-parameter: operational-carbon
```
## Full Manifest

The full manifest so far now looks like so:

```yaml
name: sci-walkthrough
description: This manifest file computes the carbon per visit for our website
tags:
initialize:
  plugins:
    memory-utilization-to-memory-energy:        
      method: Coefficient
      path: "builtin"
      config:
        input-parameter: memory-utilization 
        coefficient: 0.00039                
        output-parameter: memory-energy   
    cloud-instance-to-cpu-tdp:
      method: CSVLookup
      path: 'builtin'
      config:
        filepath: https://raw.githubusercontent.com/Green-Software-Foundation/if-course/refs/heads/main/src/cloud-metdata-azure-instances.csv
        query:
          instance-class: "cloud-instance"
        output:
          - cpu-tdp                  
    cpu-utilization-to-tdp-multiplier:
      method: Interpolation
      path: "builtin"
      config:
        method: linear
        x: [0, 10, 50, 100]
        y: [0.12, 0.32, 0.75, 1.02]
        input-parameter: "cpu-utilization"
        output-parameter: "tdp-multiplier"
    tdp-multiplier-to-cpu-power:
      method: Multiply
      path: builtin
      config:
        input-parameters: 
          - tdp-multiplier
          - cpu-tdp
        output-parameter: "cpu-power"
    cpu-power-to-cpu-energy:
      method: Divide
      path: "builtin"
      config:
        numerator: cpu-power
        denominator: 1000
        output: cpu-energy
    to-operational-energy:
      path: "builtin"
      method: Sum
      config:
        input-parameters:
          - memory-energy
          - cpu-energy
        output-parameter: operational-energy
    # highlight-start
    carbon-intensity-from-region:
      method: CSVLookup
      path: builtin
      config:
        filepath: https://raw.githubusercontent.com/Green-Software-Foundation/real-time-cloud/refs/heads/main/Cloud_Region_Metadata.csv
        query:
          cloud-provider: "cloud-provider"
          cloud-region: "cloud-region"
        output:
          - ['grid-carbon-intensity-average-consumption-annual', 'carbon-intensity']
    # highlight-end
    to-operational-carbon:
      method: Multiply
      path: builtin
      config:
        input-parameters:
          - operational-energy
          - carbon-intensity
        output-parameter: operational-carbon
tree:
  children:
    server-1:
      defaults:
        cloud-region: westeurope
        cloud-instance: Standard_A2m_v2
        cloud-provider: "Microsoft Azure"
      pipeline:
        compute:
          - memory-utilization-to-memory-energy
          - cloud-instance-to-cpu-tdp
          - cpu-utilization-to-tdp-multiplier
          - tdp-multiplier-to-cpu-power
          - cpu-power-to-cpu-energy
          - to-operational-energy
          - carbon-intensity-from-region
          - to-operational-carbon
      inputs:
        - timestamp: 2023-08-01T00:00
          duration: 3600
          memory-utilization: 8.8
          cpu-utilization: 80
          site-visits: 210
```          

And now if we run in the terminal with 

```bash
if-run -m sci-walkthrough.yml
```

An output manifest is printed to the terminal with these `outputs` appended.

```yaml
outputs:
  - timestamp: 2023-08-01T00:00
    duration: 3600
    memory-utilization: 8.8
    cpu-utilization: 80
    site-visits: 210
    cloud-region: westeurope
    cloud-instance: Standard_A2m_v2
    cloud-provider: Microsoft Azure
    memory-energy: 0.003432
    cpu-tdp: 205
    tdp-multiplier: 0.912
    cpu-power: 186.96
    cpu-energy: 0.18696000000000002
    operational-energy: 0.190392
    # highlight-start
    carbon-intensity: 283.17
    operational-carbon: 53.913302640000005
    # highlight-end
```

You can see that we now have a manifest that calculates `operational-carbon`, there is still more to do however until we can compute a sci score.